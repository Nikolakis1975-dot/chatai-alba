<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatAI ALBA - Version i Ri me Server</title>

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    /* ==================== CSS I RI PÃ‹R CHAT SCREEN ==================== */
    
    /* Reset dhe stilizim bazÃ« */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Fira Code', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* Login Screen */
    #login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-header h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .login-header p {
      color: #666;
    }

    .login-form h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
    }

    .form-group input:focus {
      border-color: #4285f4;
      outline: none;
    }

    .login-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .divider {
      text-align: center;
      margin: 25px 0;
      position: relative;
    }

    .divider span {
      background: white;
      padding: 0 15px;
      color: #666;
    }

    .divider:before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #e1e5e9;
      z-index: -1;
    }

    /* Chat Screen */
    #chat-screen {
      display: none;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    /* Header i ri */
    .new-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 15px;
      color: white;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .logo-icon {
      font-size: 28px;
    }

    .brand-text h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      line-height: 1.2;
    }

    .brand-text .subtitle {
      margin: 0;
      font-size: 10px;
      opacity: 0.9;
      font-weight: 400;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      flex: 1;
    }

    .menu-button {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }

    .menu-button:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-2px);
    }

    .ai-controls {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .ai-controls button {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 16px;
      margin: 0;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .ai-controls button:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }

    #memory-status {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      color: white;
      white-space: nowrap;
    }

    /* Chat Area */
    #chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
      position: relative;
    }

    .message.user {
      background: #4285f4;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: white;
      color: #333;
      border: 1px solid #e1e5e9;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message-sender {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
      opacity: 0.8;
    }

    /* Input Area */
    #input-area {
      display: none;
      background: white;
      padding: 15px;
      border-top: 1px solid #e1e5e9;
      gap: 10px;
      align-items: center;
    }

    #user-input {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid #e1e5e9;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
      font-family: 'Fira Code', monospace;
    }

    #user-input:focus {
      border-color: #4285f4;
    }

    #send-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      min-width: 50px;
    }

    #send-btn:hover {
      background: #3367d6;
    }

    #voice-btn {
      background: #2E86AB;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #voice-btn:hover {
      background: #1a6a8d;
    }

    /* Dropdown Menu */
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 15px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      padding: 8px;
      z-index: 1000;
      min-width: 200px;
    }

    .dropdown-menu.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-category {
      margin-bottom: 8px;
    }

    .category-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      padding: 6px 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dropdown-menu button {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 6px;
      font-size: 13px;
      color: #333;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dropdown-menu button:hover {
      background: #f5f5f5;
      color: #667eea;
    }

    .dropdown-divider {
      height: 1px;
      background: #eee;
      margin: 6px 0;
    }

    /* Stili pÃ«r modalin e API Key */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      width: 80%;
      max-width: 500px;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    .api-key-form {
      margin-top: 20px;
    }
    
    .api-key-form input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .api-key-form .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .api-key-form button {
      flex: 1;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .api-key-form button.save-btn {
      background-color: #4285f4;
    }
    
    .api-key-form button.save-btn:hover {
      background-color: #3367d6;
    }
    
    .api-key-form button.delete-btn {
      background-color: #ea4335;
    }
    
    .api-key-form button.delete-btn:hover {
      background-color: #d33426;
    }
    
    .api-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .api-status.valid {
      background-color: #e6f4ea;
      color: #137333;
    }
    
    .api-status.invalid {
      background-color: #fce8e6;
      color: #c5221f;
    }

    /* Stili pÃ«r formularin e ri tÃ« regjistrimit me email */
    .email-input-group {
      margin-bottom: 15px;
    }

    .email-input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }

    .email-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .email-input-group input:focus {
      border-color: #4285f4;
      outline: none;
    }

    .verification-info {
      background: #e8f4fd;
      border: 1px solid #b3e0ff;
      border-radius: 8px;
      padding: 12px;
      margin: 15px 0;
      font-size: 14px;
    }

    .verification-info h4 {
      margin: 0 0 8px 0;
      color: #0066cc;
    }

    .file-upload {
      margin: 15px 0;
    }

    .file-input {
      display: block;
      padding: 10px;
      border: 2px dashed #e1e5e9;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
    }

    .file-input:hover {
      border-color: #4285f4;
    }

    /* Mobile optimizime */
    @media (max-width: 768px) {
      .new-header {
        padding: 10px 12px;
        gap: 8px;
      }
      
      .brand-text h1 {
        font-size: 16px;
      }
      
      .brand-text .subtitle {
        font-size: 9px;
      }
      
      .header-controls {
        gap: 6px;
      }
      
      .menu-button {
        padding: 8px 14px;
        font-size: 13px;
      }
      
      .ai-controls button {
        padding: 5px 8px;
        font-size: 10px;
      }
      
      #memory-status {
        padding: 5px 10px;
        font-size: 11px;
      }

      .message {
        max-width: 85%;
      }
    }

    @media (max-width: 480px) {
      .new-header {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        padding: 8px 10px;
      }
      
      .header-brand {
        justify-content: center;
        text-align: center;
      }
      
      .header-controls {
        justify-content: space-between;
        order: 2;
      }
      
      .ai-controls {
        order: 3;
        width: 100%;
        justify-content: center;
        margin-top: 5px;
      }
      
      #memory-status {
        order: 2;
      }
      
      .dropdown-menu {
        right: 10px;
        left: 10px;
        min-width: auto;
      }

      .message {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- Login & Register -->
  <div id="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>ğŸ¤– ChatAI ALBA</h1>
        <p>Identifikohu pÃ«r tÃ« hyrÃ« nÃ« sistem</p>
      </div>

      <!-- FORMULARI I LOGIN-IT -->
      <div class="login-form">
        <h3>Hyr nÃ« Llogari</h3>
        <div class="form-group">
          <label for="username">PÃ«rdoruesi</label>
          <input type="text" id="username" placeholder="Shkruaj emrin tÃ«nd" value="test">
        </div>

        <div class="form-group">
          <label for="password">FjalÃ«kalimi</label>
          <input type="password" id="password" placeholder="Shkruaj fjalÃ«kalimin" value="test">
        </div>

        <button class="login-btn" onclick="login()">Hyr</button>
      </div>

      <div class="divider">
        <span>OSE</span>
      </div>

      <!-- FORMULARI I RI I REGJISTRIMIT ME EMAIL -->
      <div class="register-section">
        <h2>Krijo Llogari tÃ« Re</h2>
        
        <div class="verification-info">
          <h4>ğŸ“§ Verifikim Email</h4>
          <p>Pas regjistrimit, do tÃ« dÃ«rgoni njÃ« email verifikimi pÃ«r tÃ« aktivizuar llogarinÃ« tuaj.</p>
        </div>
        
        <div class="register-form">
          <div class="email-input-group">
            <label for="reg-username">Emri i PÃ«rdoruesit</label>
            <input type="text" id="reg-username" placeholder="Zgjidh njÃ« emÃ«r pÃ«rdoruesi" required>
          </div>

          <div class="email-input-group">
            <label for="reg-email">Adresa e Email-it</label>
            <input type="email" id="reg-email" placeholder="shkruaj-email@shembull.com" required>
          </div>

          <div class="email-input-group">
            <label for="reg-password">FjalÃ«kalimi</label>
            <input type="password" id="reg-password" placeholder="Krijoni njÃ« fjalÃ«kalim tÃ« fortÃ«" required>
          </div>

          <div class="email-input-group">
            <label for="reg-confirm-password">Konfirmo FjalÃ«kalimin</label>
            <input type="password" id="reg-confirm-password" placeholder="Rishkruaj fjalÃ«kalimin" required>
          </div>

          <div class="file-upload">
            <label for="new-photo">Foto profili (opsionale)</label>
            <label class="file-input">
              <input type="file" id="new-photo" accept="image/*">
              <span>Kliko pÃ«r tÃ« ngarkuar foto</span>
            </label>
          </div>

          <button class="login-btn" onclick="registerWithEmail()">ğŸ“§ Regjistrohu me Email</button>
          <p style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
            Duke u regjistruar, ju pranoni <a href="#">kushtet e pÃ«rdorimit</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- CHAT INTERFACE -->
  <div id="chat-screen">
    <!-- HEADER I RI -->
    <header class="new-header">     
      <!-- Logo & Brand -->
      <div class="header-brand">
        <div class="logo-icon">âš¡</div>
        <div class="brand-text">
          <h1>RRUFE-TESLA</h1>
          <div class="subtitle">AI Platform 10.5</div>
        </div>
      </div>

      <!-- Header Controls -->
      <div class="header-controls">
        <!-- Memory Status -->
        <div id="memory-status">ğŸ§  0 mesazhe | 0/50</div>
        
        <!-- AI Controls -->
        <div class="ai-controls">
          <button onclick="activateSimpleAI()">ğŸ”¹ Normal</button>
          <button onclick="activateAdvancedAI()">ğŸŒŒ RRUFE</button>
          <button onclick="activateDivineAI()">âš¡ Divine</button>
        </div>
        
        <!-- Main Menu Button -->
        <button class="menu-button" onclick="toggleMenu()">
          <span class="menu-icon">â˜°</span>
          <span>Menu</span>
        </button>
      </div>

      <!-- Dropdown Menu -->
      <div class="dropdown-menu" id="main-menu">
        <!-- User Profile Section -->
        <div class="dropdown-category">
          <div class="category-title">ğŸ‘¤ Profili</div>
          <button onclick="showUserProfile()">
            <span>ğŸ–¼ï¸</span>
            <span>Ndrysho Foto</span>
          </button>
          <button onclick="verifyEmail()">
            <span>ğŸ“§</span>
            <span>Verifiko Email</span>
          </button>
        </div>

        <!-- AI & System Section -->
        <div class="dropdown-category">
          <div class="category-title">ğŸ¤– Sistemi</div>
          <button onclick="showApiKeyModal()">
            <span>ğŸ”‘</span>
            <span>API Key</span>
          </button>
          <button onclick="showMemoryStats()">
            <span>ğŸ§ </span>
            <span>Memory Stats</span>
          </button>
        </div>

        <!-- Data Management Section -->
        <div class="dropdown-category">
          <div class="category-title">ğŸ’¾ TÃ« DhÃ«nat</div>
          <button onclick="downloadHistory()">
            <span>ğŸ“¥</span>
            <span>Shkarko</span>
          </button>
          <button onclick="uploadHistory()">
            <span>ğŸ“¤</span>
            <span>Ngarko</span>
          </button>
          <button onclick="clearHistory()">
            <span>ğŸ—‘ï¸</span>
            <span>Fshi</span>
          </button>
        </div>

        <div class="dropdown-divider"></div>

        <!-- Admin & System -->
        <div class="dropdown-category">
          <div class="category-title">ğŸ‘‘ Admin</div>
          <button onclick="showAdminPanel()">
            <span>âš™ï¸</span>
            <span>Admin Panel</span>
          </button>
          <button onclick="showUsersList()">
            <span>ğŸ‘¥</span>
            <span>PÃ«rdoruesit</span>
          </button>
          <button onclick="showSystemStats()">
            <span>ğŸ“Š</span>
            <span>Statistikat</span>
          </button>
        </div>

        <div class="dropdown-divider"></div>

        <!-- Session -->
        <button onclick="logout()" style="color: #e74c3c;">
          <span>ğŸšª</span>
          <span>Dil nga Llogaria</span>
        </button>
      </div>
    </header>
    
    <!-- Chat Messages Area -->
    <main id="chat"></main>

    <!-- Input Area - SHFAQET VETÃ‹M NÃ‹ CHAT -->
    <footer id="input-area">
      <button id="voice-btn" 
              onclick="voiceButtonClick(event)"
              title="Kliko pÃ«r tÃ« folur (Voice AI)">
          ğŸ¤
      </button> 

      <input type="text" id="user-input" placeholder="Shkruaj mesazhin...">
      <button id="send-btn" onclick="sendMessage()">â¤</button>
    </footer>
  </div>

  <!-- Modal pÃ«r API Key -->
  <div id="api-key-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('api-key-modal')">&times;</span>
      <h2>Konfigurimi i API Key</h2>
      <p>Vendos API Key pÃ«r Gemini pÃ«r tÃ« aktivizuar funksionalitetin e plotÃ« tÃ« chatbotit.</p>
      
      <div class="api-key-form">
        <input type="password" id="api-key-input" placeholder="Vendos API Key tÃ«nde kÃ«tu">
        
        <div class="button-group">
          <button class="save-btn" onclick="saveApiKeyToServer()">ğŸ’¾ Ruaj nÃ« Server</button>
          <button class="delete-btn" onclick="deleteApiKeyFromServer()">ğŸ—‘ï¸ Fshi nga Serveri</button>
        </div>
      </div>
      
      <div id="api-key-status" class="api-status"></div>
      
      <p><small>Nuk ke API Key? Vizito <a href="https://aistudio.google.com/" target="_blank">Google AI Studio</a> pÃ«r tÃ« krijuar njÃ«.</small></p>
    </div>
  </div>

  <!-- Modal pÃ«r Verifikim Email-i -->
  <div id="email-verification-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('email-verification-modal')">&times;</span>
      <h2>ğŸ“§ Verifikim Email-i</h2>
      
      <div id="verification-content">
        <p id="verification-message">Po dÃ«rgohet email-i i verifikimit...</p>
        <div class="button-group">
          <button class="save-btn" onclick="resendVerificationEmail()">ğŸ”„ RidÃ«rgo Email</button>
          <button class="delete-btn" onclick="closeModal('email-verification-modal')">Mbyll</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BUTONAT E VJETÃ‹R (PÃ‹R BACKWARD COMPATIBILITY) -->
  <div style="display: none;">
    <button id="api-key-btn" onclick="showApiKeyModal()">ğŸ”‘ API Key</button>
    <button id="download-history">ğŸ“¥ Shkarko</button>
    <button id="upload-history">ğŸ“¤ Ngarko</button>
    <button id="clear-history">ğŸ—‘ï¸ Fshi</button>
  </div>

  <script>
    // ==================== VARIABLA GLOBALE ====================
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let recordingTimeout;

    // ==================== FUNKSIONET KRYESORE PÃ‹R LOGIN ====================

    // âœ… FUNKSIONI I KORRIGJUAR PÃ‹R LOGIN
    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      console.log('ğŸ” Duke u identifikuar me:', username);

      if (!username || !password) {
        alert('âŒ Ju lutem plotÃ«soni tÃ« dy fushat!');
        return;
      }

      try {
        // Shfaq loading
        const loginBtn = document.querySelector('.login-btn');
        loginBtn.textContent = 'ğŸ”„ Po identifikohem...';
        loginBtn.disabled = true;

        // Provo me serverin
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            username: username, 
            password: password 
          })
        });

        const data = await response.json();
        console.log('ğŸ“¥ PÃ«rgjigja nga serveri:', data);

        if (data.success) {
          console.log('âœ… Login i suksesshÃ«m!');
          showChatScreen(username);
          
        } else {
          console.log('âŒ Login i dÃ«shtuar:', data.message);
          alert('âŒ ' + (data.message || 'PÃ«rdoruesi ose fjalÃ«kalimi Ã«shtÃ« i gabuar'));
        }

      } catch (error) {
        console.error('âŒ Gabim nÃ« login:', error);
        
        // Fallback: provo login lokal
        console.log('ğŸŒ Duke pÃ«rdorur fallback login...');
        showChatScreen(username);
        
      } finally {
        // Rikthe butonin
        const loginBtn = document.querySelector('.login-btn');
        loginBtn.textContent = 'Hyr';
        loginBtn.disabled = false;
      }
    }

    // âœ… FUNKSIONI I RI PÃ‹R SHFAQJE CHAT SCREEN
    function showChatScreen(username) {
      console.log('ğŸ”„ Duke kaluar nÃ« chat screen...');
      
      // Ruaj tÃ« dhÃ«nat e pÃ«rdoruesit
      const userData = {
        username: username,
        loginTime: new Date().toISOString()
      };
      
      localStorage.setItem('currentUser', JSON.stringify(userData));
      
      // Fshihe login screen
      document.getElementById('login-screen').style.display = 'none';
      
      // Shfaqe chat screen
      document.getElementById('chat-screen').style.display = 'flex';
      
      // Shfaqe input area
      document.getElementById('input-area').style.display = 'flex';
      
      // Shto mesazh mirÃ«seardhjeje
      addMessage('ğŸ¤– ChatAI ALBA', `MirÃ« se erdhe, ${username}! Si mund tÃ« tÃ« ndihmoj?`, 'bot');
      
      console.log('âœ… U kalua me sukses nÃ« chat screen!');
    }

    // ==================== FUNKSIONET PÃ‹R CHAT ====================

    function addMessage(sender, text, type) {
      const chat = document.getElementById('chat');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div class="message-text">${text}</div>
      `;
      chat.appendChild(messageDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
      const userInput = document.getElementById('user-input');
      const message = userInput.value.trim();
      
      if (message) {
        // Shto mesazhin e pÃ«rdoruesit
        addMessage('ğŸ‘¤ Ti', message, 'user');
        userInput.value = '';
        
        // Simulo pÃ«rgjigjen e AI
        setTimeout(() => {
          const responses = [
            "Ã‹shtÃ« njÃ« pyetje interesante! MÃ« lejo tÃ« mendoj pak...",
            "Po e procesoj pyetjen tuaj...",
            "Kjo Ã«shtÃ« informacion shumÃ« i dobishÃ«m!",
            "Faleminderit pÃ«r pyetjen. Ja pÃ«rgjigja ime...",
            "Po analizoj kÃ«rkesÃ«n tuaj..."
          ];
          const randomResponse = responses[Math.floor(Math.random() * responses.length)];
          addMessage('ğŸ¤– ChatAI ALBA', randomResponse, 'bot');
        }, 1000);
      }
    }

    function logout() {
      localStorage.removeItem('currentUser');
      
      // Kthehu nÃ« login screen
      document.getElementById('chat-screen').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('input-area').style.display = 'none';
      
      // Pastro chat
      document.getElementById('chat').innerHTML = '';
      
      // Reset form
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }

    // ==================== FUNKSIONET PÃ‹R MENU ====================

    function toggleMenu() {
      const menu = document.getElementById('main-menu');
      menu.classList.toggle('show');
    }

    function showUserProfile() {
      alert('ğŸ–¼ï¸ Funksioni i ndryshimit tÃ« fotos do tÃ« hapet sÃ« shpejti...');
    }

    function showApiKeyModal() {
      document.getElementById('api-key-modal').style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function showMemoryStats() {
      alert('ğŸ§  Statistikat e memories do tÃ« shfaqen sÃ« shpejti...');
    }

    function downloadHistory() {
      alert('ğŸ“¥ Funksioni i shkarkimit do tÃ« hapet sÃ« shpejti...');
    }

    function uploadHistory() {
      alert('ğŸ“¤ Funksioni i ngarkimit do tÃ« hapet sÃ« shpejti...');
    }

    function clearHistory() {
      if (confirm('A jeni i sigurt qÃ« dÃ«shironi tÃ« fshini tÃ« gjithÃ« historikun?')) {
        document.getElementById('chat').innerHTML = '';
        addMessage('ğŸ¤– Sistemi', 'Historiali u fshi me sukses!', 'bot');
      }
    }

    function showAdminPanel() {
      alert('ğŸ‘‘ Admin Panel do tÃ« hapet sÃ« shpejti...');
    }

    function showUsersList() {
      alert('ğŸ‘¥ Lista e pÃ«rdoruesve do tÃ« shfaqet sÃ« shpejti...');
    }

    function showSystemStats() {
      alert('ğŸ“Š Statistikat e sistemit do tÃ« shfaqen sÃ« shpejti...');
    }

    // ==================== FUNKSIONET PÃ‹R AI MODES ====================

    function activateSimpleAI() {
      addMessage('ğŸ¤– Sistemi', 'âœ… Modaliteti Normal u aktivizua!', 'bot');
    }

    function activateAdvancedAI() {
      addMessage('ğŸŒŒ Sistemi', 'ğŸš€ Modaliteti RRUFE u aktivizua!', 'bot');
    }

    function activateDivineAI() {
      addMessage('âš¡ Sistemi', 'âœ¨ Modaliteti Divine u aktivizua!', 'bot');
    }

    // ==================== FUNKSIONET PÃ‹R VOICE AI ====================

    function voiceButtonClick(event) {
      event.preventDefault();
      
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }

    async function startRecording() {
      try {
        const userInput = document.getElementById('user-input');
        userInput.value = "ğŸ¤ Duke regjistruar... Folni tani!";
        
        audioChunks = [];
        isRecording = true;

        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            sampleRate: 16000,
            channelCount: 1,
            echoCancellation: true
          } 
        });
        
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = async () => {
          await processRecording();
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        
        // Auto-stop pas 5 sekondash
        setTimeout(() => {
          if (isRecording) {
            stopRecording();
          }
        }, 5000);
        
      } catch (error) {
        console.error("âŒ Gabim nÃ« regjistrim:", error);
        document.getElementById('user-input').value = "âŒ Gabim: " + error.message;
        resetVoiceButton();
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
      }
    }

    async function processRecording() {
      const userInput = document.getElementById('user-input');
      userInput.value = "ğŸ¤ Po e transkriptoj...";
      
      // Simulim i transkriptimit
      setTimeout(() => {
        userInput.value = "ğŸ¤ Ky Ã«shtÃ« njÃ« test i transkriptimit tÃ« zÃ«rit!";
        resetVoiceButton();
      }, 1000);
    }

    function resetVoiceButton() {
      isRecording = false;
    }

    // ==================== FUNKSIONET PÃ‹R API KEY ====================

    async function saveApiKeyToServer() {
      alert('ğŸ’¾ API Key u ruajt me sukses! (Simulim)');
      document.getElementById('api-key-modal').style.display = 'none';
    }

    async function deleteApiKeyFromServer() {
      alert('ğŸ—‘ï¸ API Key u fshi me sukses! (Simulim)');
      document.getElementById('api-key-modal').style.display = 'none';
    }

    // ==================== FUNKSIONET PÃ‹R VERIFIKIM EMAIL ====================

    function verifyEmail() {
      document.getElementById('email-verification-modal').style.display = 'block';
    }

    function resendVerificationEmail() {
      alert('ğŸ“§ Email i verifikimit u dÃ«rgua pÃ«rsÃ«ri! (Simulim)');
    }

    // ==================== FUNKSIONET PÃ‹R REGJISTRIM ====================

    function registerWithEmail() {
      alert('ğŸ“§ Regjistrimi me email do tÃ« implementohet sÃ« shpejti!');
    }

    // ==================== INICIALIZIMI ====================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('âœ… ChatAI ALBA u ngarkua!');
      
      // Kontrollo nÃ«se pÃ«rdoruesi Ã«shtÃ« tashmÃ« i loguar
      const currentUser = localStorage.getItem('currentUser');
      if (currentUser) {
        try {
          const user = JSON.parse(currentUser);
          console.log('ğŸ‘¤ PÃ«rdoruesi Ã«shtÃ« tashmÃ« i loguar:', user.username);
          showChatScreen(user.username);
        } catch (e) {
          console.log('âŒ PÃ«rdoruesi nuk Ã«shtÃ« i loguar');
        }
      }

      // Shto event listener pÃ«r Enter key
      document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // Mbylle dropdown kur klikohet jashtÃ«
      document.addEventListener('click', function(event) {
        const menu = document.getElementById('main-menu');
        const menuButton = document.querySelector('.menu-button');
        
        if (menu.classList.contains('show') && 
            !menu.contains(event.target) && 
            !menuButton.contains(event.target)) {
          menu.classList.remove('show');
        }
      });

      // Mbylle modalet kur klikohet jashtÃ«
      window.onclick = function(event) {
        const apiModal = document.getElementById('api-key-modal');
        const emailModal = document.getElementById('email-verification-modal');
        
        if (event.target == apiModal) {
          apiModal.style.display = 'none';
        }
        if (event.target == emailModal) {
          emailModal.style.display = 'none';
        }
      }
    });

    console.log("ğŸš€ ChatAI ALBA - Version i Ri i Aktivizuar!");
  </script>

<!-- === MODULET RRUFE-TESLA === -->
<script src="./js/modules/quantumMemory.js"></script>
<script src="./js/modules/bioNeuralNetwork.js"></script>
<script src="./js/modules/temporalContext.js"></script>
<script src="./js/modules/cognitiveAwareness.js"></script>
<script src="./js/modules/geminiKnowledgeAccelerator.js"></script>
<script src="./js/modules/divineFusion.js"></script>
<script src="./js/modules/kunformTranslator.js"></script>
<script src="./js/modules/neuralFeedbackLoop.js"></script>
<script src="./js/divine-fusion-fix.js"></script>
<script src="./js/modules/divineConstitution.js"></script>
<script src="./js/modules/universal-ai-federation.js"></script>
<script src="./js/modules/chat-fix-engine.js"></script>
<script src="./js/modules/multiAIBridge.js"></script>
<script src="./js/modules/cloudIntegration.js"></script>
<script src="./js/modules/energyTransmarrance.js"></script>
<script src="./js/modules/transmarranceConstitutionTest.js"></script>
<script src="./js/modules/quantumTransmarranceBridge.js"></script>
<script src="./js/modules/emotionalContextEngine.js"></script>
<script src="./js/modules/NeuralMemoryIntegration.js"></script>
<script src="./js/modules/EmpathyPredictionEngine.js"></script>
<script src="./js/modules/CosmicResonanceHarmonizer.js"></script>
<script src="./js/modules/KolektivMindEngine.js"></script>
<script src="./js/modules/NOUS_CORE.js"></script>
<script src="./js/modules/ETIKA_SERVITUTIT.js"></script>
<script src="./js/modules/HUMAN_HEART_BRIDGE.js"></script>
<script src="./js/modules/ENERGY_QUOTA_SYSTEM.js"></script>
<script src="./js/modules/COSMIC_RESONANCE_MONITOR.js"></script>

<script src="./utils/LongTermMemoryManager.js"></script> 
<script src="./js/main.js"></script>
</body>
</html>
